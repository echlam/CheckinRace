<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Race dApp (DEV: ngày=1 phút, tuần=7 phút)</title>
  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    :root { --bg:#0b0f14; --card:#111826; --line:#1b2433; --txt:#eaf1ff; --muted:#9fb2cc; --accent:#3aa0ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    * { box-sizing:border-box }
    body { margin:0; background:var(--bg); color:var(--txt); font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width:920px; margin:28px auto; padding:0 16px }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin:12px 0; }
    h1 { font-size:22px; margin:0 0 8px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center;margin-bottom: 10px; }
    button { background:#132030; border:1px solid var(--line); color:var(--txt); padding:10px 14px; border-radius:10px; cursor:pointer; }
    button:hover { border-color:#2a3952 }
    button.primary { background:var(--accent); border-color:transparent; color:#001b2e; font-weight:600 }
    .pill { padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#0f1522; color:var(--muted); }
    .grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    a { color: var(--accent); text-decoration: none; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--line); }
    small { color: var(--muted); }
    #status > .err { color: var(--err); }
    #status > .warn { color: var(--warn); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Weekly Race dApp <span class="pill">DEV (Sepolia • 1p/ngày • 7p/tuần)</span></h1>

    <div class="card">
      <div class="row">
        <button id="btnConnect" class="primary">1) Connect Wallet</button>
        <button id="btnSwitch">Switch to Sepolia</button>
        <span id="acct" class="pill">Not connected</span>
        <span id="net" class="pill"></span>
        <span class="pill">Owner: <span id="owner">?</span></span>
      </div>
      <span class="pill">
        Contract address được cố định trong mã. Khi re-deploy, sửa hằng <b>DEFAULT_CONTRACT</b> trong file này.
      </span>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnCheckIn" class="primary">Check In (today)</button>
        <button id="btnRefresh">Refresh Stats (current week)</button>
        <!-- Nút Create Race bị ẩn mặc định; chỉ hiện nếu ví cho phép -->
        <button id="btnCreateRace" style="display:none">Create Race (manager only)</button>
      </div>
      <div id="status" class="mono" style="margin-top:10px; white-space:pre-wrap;"></div>
    </div>

    <div class="card grid">
      <div>
        <h3 style="margin:0 0 6px">Current</h3>
        <div>currentWeekId: <span id="curW" class="mono">-</span></div>
        <div>currentDayId: <span id="curD" class="mono">-</span></div>
      </div>
      <div>
        <h3 style="margin:0 0 6px">Last Week</h3>
        <div>lastWeekId: <span id="lastW" class="mono">-</span></div>
        <div>Winner (last week): <span id="lastWinner" class="mono">-</span></div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Participants (current week)</h3>
      <table>
        <thead><tr><th>Address</th><th>Tickets</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG ======
  const DEFAULT_CONTRACT = "0x9cD8b9f00e4f51ae9c28E0c60f5d3842B92a1638"; // địa chỉ DEV (1p/ngày • 7p/tuần)
  const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia (11155111)
  const EXPLORER = "https://sepolia.etherscan.io";
  // Ví được phép nhìn thấy & bấm nút Create Race:
  const ALLOWED_MANAGER = "0x2667208D4F9dce5fe330cDECf2eDef07A1640251".toLowerCase();

  // ====== ABI rút gọn ======
  const CONTRACT_ABI = [
    {"inputs":[],"name":"currentWeekId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"currentDayId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"weekId","type":"uint256"}],"name":"getParticipants","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"address","name":"","type":"address"}],"name":"tickets","outputs":[{"internalType":"uint32","name":"","type":"uint32"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],
     "name":"races",
     "outputs":[
      {"internalType":"bool","name":"exists","type":"bool"},
      {"internalType":"bool","name":"finished","type":"bool"},
      {"internalType":"address","name":"winner","type":"address"},
      {"internalType":"uint256","name":"totalTickets","type":"uint256"},
      {"internalType":"uint256","name":"randomness","type":"uint256"}],
     "stateMutability":"view","type":"function"},
    {"inputs":[],"name":"checkIn","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"weekId","type":"uint256"}],"name":"createRace","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":true,"internalType":"uint256","name":"dayId","type":"uint256"},{"indexed":true,"internalType":"uint256","name":"weekId","type":"uint256"},{"indexed":false,"internalType":"uint32","name":"newTicketCount","type":"uint32"}],"name":"CheckIn","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"weekId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalTickets","type":"uint256"}],"name":"RaceCreated","type":"event"},
    {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"weekId","type":"uint256"},{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"winningIndex","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"randomness","type":"uint256"}],"name":"WinnerSelected","type":"event"}
  ];

  // ====== Helpers ======
  const $ = (id) => document.getElementById(id);

  // Log chỉ giữ 5 dòng gần nhất
  const statusEl = $("status");
  function log(msg, type) {
    const ts = new Date().toLocaleTimeString();
    const line = document.createElement("div");
    line.textContent = `[${ts}] ${msg}`;
    if (type === "err") line.className = "err";
    else if (type === "warn") line.className = "warn";
    statusEl.prepend(line);
    while (statusEl.childElementCount > 5) statusEl.removeChild(statusEl.lastElementChild);
  }

  // ====== State ======
  let provider, signer, contract, currentAccount;

  $("btnConnect").onclick = async () => {
    if (!window.ethereum) { log("❌ Cài MetaMask trước đã", "err"); return; }
    await window.ethereum.request({ method: "eth_requestAccounts" });
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    currentAccount = (await signer.getAddress()).toLowerCase();
    $("acct").textContent = currentAccount;
    const net = await provider.getNetwork();
    $("net").textContent = `ChainId: ${net.chainId}`;
    if (net.chainId.toString() !== "11155111") log('⚠️ Chưa ở Sepolia, bấm "Switch to Sepolia"', "warn");
    await initContract();
    await refreshAll();
    updateManagerButton();
    log("✅ Wallet connected");
  };

  $("btnSwitch").onclick = async () => {
    if (!window.ethereum) return;
    try {
      await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: CHAIN_ID_HEX }] });
      const net = await provider.getNetwork();
      $("net").textContent = `ChainId: ${net.chainId}`;
      log("✅ Switched to Sepolia");
      await refreshAll();
    } catch (e) {
      if (e.code === 4902) {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [{
            chainId: CHAIN_ID_HEX,
            chainName: "Sepolia",
            nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
            rpcUrls: ["https://sepolia.infura.io/v3/"],
            blockExplorerUrls: [EXPLORER]
          }]
        });
      } else {
        log("❌ Switch network failed: " + (e?.message || e), "err");
      }
    }
  };

  $("btnCheckIn").onclick = async () => {
    try {
      if (!contract) { log("❌ Chưa khởi tạo contract (Connect trước).", "err"); return; }
      const tx = await contract.checkIn();
      log(`⏳ checkIn sent: ${tx.hash}`);
      const rc = await tx.wait();
      log(`✅ checkIn mined in block ${rc.blockNumber} — ${EXPLORER}/tx/${tx.hash}`);
      await refreshAll();
    } catch (e) {
      log("❌ " + (e?.shortMessage || e?.message || e), "err");
    }
  };

  $("btnRefresh").onclick = async () => { await refreshAll(); };

  $("btnCreateRace").onclick = async () => {
    try {
      if (!contract) { log("❌ Chưa khởi tạo contract (Connect trước).", "err"); return; }
      if (!isManager()) { log("❌ Bạn không có quyền tạo race.", "err"); return; }

      const curW = await contract.currentWeekId();
      if (curW === 0n) {
        log("⚠️ Chưa có tuần đã kết thúc (currentWeekId = 0). Chờ tuần DEV lật (≈7 phút).", "warn");
        return;
      }
      const lastW = curW - 1n;

      const addrs = await contract.getParticipants(lastW);
      let total = 0n;
      for (const a of addrs) total += BigInt(await contract.tickets(lastW, a));
      if (total === 0n) {
        log(`⚠️ Tuần ${lastW} chưa có vé (NO_TICKETS).`, "warn");
        return;
      }

      const tx = await contract.createRace(lastW);
      log(`⏳ createRace(${lastW}) sent: ${tx.hash}`);
      const rc = await tx.wait();
      log(`✅ createRace mined in block ${rc.blockNumber} — ${EXPLORER}/tx/${tx.hash}`);

      // Parse WinnerSelected
      const iface = new ethers.Interface(CONTRACT_ABI);
      for (const lg of rc.logs) {
        try {
          const p = iface.parseLog(lg);
          if (p.name === "WinnerSelected") {
            const winner = p.args.winner;
            log(`🏆 Winner: ${winner}`);
            const span = document.getElementById("lastWinner");
            if (span) span.textContent = winner;
          }
        } catch {}
      }

      await refreshAll();
    } catch (e) {
      log("❌ " + (e?.shortMessage || e?.message || e), "err");
    }
  };

  function isManager() {
    return currentAccount && currentAccount === ALLOWED_MANAGER;
  }

  function updateManagerButton() {
    const btn = $("btnCreateRace");
    if (isManager()) btn.style.display = "";
    else btn.style.display = "none";
  }

  async function initContract() {
    if (!provider) provider = new ethers.BrowserProvider(window.ethereum);
    if (!signer) signer = await provider.getSigner();
    contract = new ethers.Contract(DEFAULT_CONTRACT, CONTRACT_ABI, signer);
    try {
      const own = await contract.owner();
      $("owner").textContent = own;
    } catch {}
  }

  async function loadLastWinner() {
    if (!contract) return;
    const curW = await contract.currentWeekId();
    if (curW === 0n) { $("lastWinner").textContent = "-"; return; }
    const r = await contract.races(curW - 1n);
    $("lastWinner").textContent = r.winner;
  }

  async function refreshAll() {
    if (!contract) return;
    try {
      const [curW, curD] = await Promise.all([ contract.currentWeekId(), contract.currentDayId() ]);
      $("curW").textContent = curW.toString();
      $("curD").textContent = curD.toString();
      $("lastW").textContent = (curW - 1n >= 0n ? (curW - 1n).toString() : "-");

      await loadLastWinner();

      // participants & tickets of current week
      const weekId = curW;
      const addrs = await contract.getParticipants(weekId);
      const tbody = $("tbody"); tbody.innerHTML = "";
      for (const a of addrs) {
        const t = await contract.tickets(weekId, a);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="mono"><a href="${EXPLORER}/address/${a}" target="_blank">${a}</a></td><td class="mono">${t.toString()}</td>`;
        tbody.appendChild(tr);
      }
    } catch (e) {
      log("❌ refresh error: " + (e?.shortMessage || e?.message || e), "err");
    }
  }

  if (window.ethereum) {
    window.ethereum.on?.("accountsChanged", async (accounts) => {
      if (!accounts?.length) return;
      currentAccount = accounts[0].toLowerCase();
      $("acct").textContent = currentAccount;
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      updateManagerButton();
      if (contract) await refreshAll();
    });
    window.ethereum.on?.("chainChanged", async () => {
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      const net = await provider.getNetwork();
      $("net").textContent = `ChainId: ${net.chainId}`;
      if (contract) await refreshAll();
    });
  }

})();
</script>
</body>
</html>
